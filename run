#!/bin/bash

source ./scripts/getopts
source ./config/env
source ./config/ann

TIMESTAMP=$(date +"%Y-%m-%d_%H.%M.%S")
export OUT_DIR="output/output_$TIMESTAMP"
mkdir -p $OUT_DIR $OUT_DIR/tmp $OUT_DIR/annotation

while IFS=',' read -r var value; do
  if [ "$var" == "future.mem" ]
  then
    MEMORY="$value"
  fi

  if [ "$var" == "future.workers" ]
  then
    WORKERS="$value"
  fi
done < config/params.csv

if [[ "${atac:-}" == "TRUE" ]]
then
  SEURAT_IMAGE=seurat-signac
fi

if [[ -z ${SEURAT_IMAGE_VER} ]]
then
  echo -e "Seurat image version tag needs to be supplied using the -v argument.\n\nFind available versions at https://gallery.ecr.aws/chobiolab/$SEURAT_IMAGE"
  exit 1
fi

echo "Using Seurat image $SEURAT_IMAGE:$SEURAT_IMAGE_VER"

singularity run \
  --no-home \
  --pwd $APP_PATH \
  -B $DATA_PATH:$DATA_PATH \
  -B $APP_PATH:$APP_PATH \
  -B ./config/params.csv:/app/config/params.csv \
  -B ./config/samples.csv:/app/config/samples.csv \
  docker://public.ecr.aws/chobiolab/$SEURAT_IMAGE:$SEURAT_IMAGE_VER $APP_PATH/main "$@"

INPUT=`pwd`/$OUT_DIR
cd annotation
./run -i $INPUT/integrated.RDS -m $MODEL -w $WORKERS -r $MEMORY
cd ..

mv annotation/output/output_*/* ${OUT_DIR}/annotation
rm -rf annotation/output
